---
name: 图片宽度过滤功能
description: 为SimpleDataSet类添加基于图片宽度的过滤功能，支持在模型评估时聚焦特定尺寸范围的图片
status: backlog
created: 2025-09-03T03:37:11Z
---

# PRD: 图片宽度过滤功能

## Executive Summary

为PaddleOCR的SimpleDataSet类添加图片宽度过滤功能，通过在transforms配置中添加FilterByImageWidth变换操作符，使tools/eval.py在验证模型性能时能够聚焦于指定宽度范围的图片，从而更准确地评估模型在特定场景下的表现。

## Problem Statement

### 当前痛点
- **评估结果不够精确**：当前eval.py会处理所有尺寸的图片，无法针对特定宽度范围进行精确的性能评估
- **缺乏场景化测试**：无法针对移动端、小图片或大图片等特定应用场景进行专门的模型性能验证
- **异常数据干扰**：极端尺寸的图片可能影响整体评估结果的代表性

### 为什么现在重要
- **精准评估需求**：随着OCR应用场景多样化，需要针对不同尺寸图片的专项性能评估
- **模型优化指导**：通过分段评估可以更好地指导模型在特定场景下的优化方向
- **架构兼容性**：需要与现有transforms架构完美融合，不破坏现有功能

## User Stories

### 主要用户角色
- **算法工程师**：需要评估模型在不同尺寸图片上的表现
- **产品团队**：需要针对特定应用场景验证模型效果
- **研究人员**：需要进行细分场景的实验分析

### 用户旅程

#### 场景1：移动端小图片性能评估
**作为**算法工程师  
**我想要**评估模型在宽度0-80像素小图片上的识别准确率  
**这样**我可以优化移动端应用的用户体验  

**接受标准：**
- 可通过YAML配置`width_range: [0, 80]`过滤图片
- eval.py只处理符合条件的图片进行评估
- 日志显示过滤统计信息

#### 场景2：高清大图片性能测试
**作为**产品经理  
**我想要**测试模型在大尺寸图片（宽度>1000像素）上的表现  
**这样**我可以确定高分辨率场景下的产品表现  

**接受标准：**
- 可通过YAML配置`width_range: [1000, ]`过滤图片
- 系统自动跳过不符合条件的图片
- 输出过滤后的样本数量统计

#### 场景3：标准尺寸范围测试
**作为**研究人员  
**我想要**在特定宽度范围（如100-500像素）内评估模型  
**这样**我可以排除极端尺寸对实验结果的影响  

**接受标准：**
- 可通过YAML配置`width_range: [100, 500]`设置范围
- 不符合条件的图片被自动跳过
- 详细的过滤统计信息记录

## Requirements

### Functional Requirements

#### FR1：FilterByImageWidth变换操作符
- **功能描述**：创建新的变换操作符类FilterByImageWidth
- **输入参数**：width_range配置（支持[min, max]、[min, ]、None格式）
- **处理逻辑**：
  - 检查图片宽度是否在指定范围内
  - 符合条件：继续后续处理
  - 不符合条件：返回None触发跳过机制
- **位置**：ppocr/data/imaug/operators.py

#### FR2：YAML配置支持
- **配置格式**：
  ```yaml
  transforms:
    - DecodeImage:
        img_mode: BGR
        channel_first: false
    - FilterByImageWidth:
        width_range: [0, 80]  # 示例：只保留宽度0-80像素的图片
    - # 其他transforms...
  ```
- **配置选项**：
  - `[min, max]`：保留宽度在min到max之间的图片
  - `[min, ]`：保留宽度大于等于min的图片
  - `None`：不进行过滤（默认行为）

#### FR3：统计信息记录
- **统计内容**：
  - 总图片数量
  - 被过滤的图片数量
  - 过滤后剩余的图片数量
  - 过滤率（百分比）
- **输出位置**：通过logger输出到控制台和日志文件
- **输出时机**：在数据加载完成后输出统计摘要

#### FR4：与现有架构集成
- **集成方式**：作为标准transforms操作符
- **错误处理**：利用现有的None返回机制触发样本跳过
- **配置注册**：在operators.py中注册新的操作符类

### Non-Functional Requirements

#### NFR1：性能要求
- **处理速度**：图片宽度检查不应显著增加数据加载时间
- **内存占用**：过滤操作不应额外占用显著内存
- **兼容性**：与现有transforms操作符完全兼容

#### NFR2：可维护性
- **代码质量**：遵循PaddleOCR现有代码规范
- **文档完善**：提供清晰的使用文档和示例
- **测试覆盖**：包含单元测试和集成测试

#### NFR3：用户体验
- **配置简单**：通过标准YAML配置，无需修改代码
- **信息清晰**：日志输出直观易懂的统计信息
- **错误友好**：配置错误时提供清晰的错误信息

## Success Criteria

### 可衡量的结果

#### 主要指标
1. **功能完整性**：100%支持所有定义的width_range配置格式
2. **性能影响**：数据加载时间增加<5%
3. **统计准确性**：过滤统计信息100%准确

#### 验收标准
- [ ] 所有width_range配置格式正确工作
- [ ] 过滤后的eval.py结果只包含指定范围内的图片
- [ ] 日志正确显示过滤统计信息
- [ ] 不破坏现有任何功能
- [ ] 通过所有单元测试和集成测试

## Constraints & Assumptions

### 技术限制
- **框架依赖**：必须基于PaddlePaddle和现有transforms架构
- **配置方式**：只支持YAML配置，不支持命令行参数
- **图片格式**：依赖DecodeImage操作符已完成图片解码

### 资源限制
- **开发时间**：预计2-3天完成开发和测试
- **测试资源**：需要包含不同尺寸图片的测试数据集
- **文档资源**：需要更新相关使用文档

### 假设条件
- DecodeImage操作符已经完成图片解码，图片尺寸信息可获取
- 用户理解transforms的执行顺序，会将FilterByImageWidth放在合适位置
- 日志系统能正常工作并输出统计信息

## Out of Scope

### 明确不包含的功能
- **高度过滤**：本版本只支持宽度过滤，不支持高度或宽高比过滤
- **命令行配置**：不支持通过eval.py命令行参数配置过滤条件
- **图片格式转换**：不负责图片格式的转换和预处理
- **动态配置**：不支持运行时动态修改过滤条件
- **复杂过滤逻辑**：不支持基于图片内容或其他元数据的过滤

### 未来版本考虑
- 支持高度和宽高比过滤
- 支持更复杂的过滤条件组合
- 提供过滤结果的详细分析报告

## Dependencies

### 外部依赖
- **PaddlePaddle框架**：核心深度学习框架支持
- **现有transforms系统**：依赖ppocr/data/imaug/operators.py架构
- **logger系统**：依赖PaddleOCR内置的日志系统

### 内部团队依赖
- **数据团队**：提供包含不同尺寸图片的测试数据集
- **文档团队**：更新使用文档和配置示例
- **测试团队**：验证功能完整性和性能影响

### 开发顺序依赖
1. 首先实现FilterByImageWidth操作符类
2. 然后集成到operators注册系统
3. 添加统计信息记录功能
4. 最后完成测试和文档更新

---

*此PRD文档版本1.0，创建于2025-09-03，后续将根据开发进展和反馈进行迭代更新。*